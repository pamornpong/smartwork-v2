<!DOCTYPE html>
<html lang="th">
  <head>
    <meta charset="UTF-8" />
    <title>SMARTWORK – บันทึกผลงาน</title>

    <link
      href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600&display=swap"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
      body {
        font-family: "TH Sarabun New", "Sarabun", sans-serif;
        background: #f3f3f3;
        margin: 0;
        padding: 15px;
      }
      .container {
        max-width: 800px;
        margin: auto;
        background: #fff;
        padding: 24px 30px;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      }
      h2 {
        text-align: center;
        font-size: 28px;
        margin: 5px 0 20px 0;
      }
      label {
        font-size: 19px;
        font-weight: 600;
        margin-top: 8px;
        display: block;
      }
      input,
      select,
      textarea {
        width: 100%;
        padding: 9px 12px;
        font-size: 18px;
        border-radius: 8px;
        border: 1px solid #bbb;
        margin-bottom: 14px;
      }
      input[disabled] {
        background: #eee;
      }
      textarea {
        height: 130px;
        resize: vertical;
      }
      button {
        width: 100%;
        padding: 12px;
        font-size: 20px;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        margin-top: 10px;
      }
      #submitBtn {
        background: #1e4bb8;
        color: #fff;
      }
      #clearBtn {
        background: #555;
        color: #fff;
      }
      #navIndex {
        background: #0a7b34;
        color: #fff;
      }
      #navReport {
        background: #a35700;
        color: #fff;
      }

      .preview-row {
        display: flex;
        flex-wrap: wrap;
        gap: 10px;
      }
      .preview-row img {
        width: 120px;
        height: 90px;
        object-fit: cover;
        border-radius: 8px;
        border: 1px solid #aaa;
      }
    </style>
  </head>

  <body>
    <div class="container">
      <h2>บันทึกผลงาน (SMARTWORK)</h2>

      <form id="workForm" onsubmit="return false;">
        <label>ชื่อ - สกุล</label>
        <input id="fullname" disabled />

        <label>ตำแหน่ง</label>
        <input id="position" disabled />

        <label>สังกัด</label>
        <input id="unit" disabled />

        <label>วันที่ของกิจกรรม</label>
        <input type="date" id="workDate" required />

        <label>ชื่องาน / รายการกิจกรรม</label>
        <input id="title" required />

        <label>รายละเอียดงาน</label>
        <textarea id="detail" required></textarea>

        <label>ตัวชี้วัด</label>
        <select id="indicator" required>
          <option value="">— เลือกตัวชี้วัด —</option>
          <option value="1) จัดการเรียนรู้ตามหลักสูตร">
            1) จัดการเรียนรู้ตามหลักสูตร
          </option>
          <option value="2) ส่งเสริมสนับสนุนการเรียนรู้">
            2) ส่งเสริมสนับสนุนการเรียนรู้
          </option>
          <option value="3) นิเทศ กำกับ ติดตาม">3) นิเทศ กำกับ ติดตาม</option>
          <option value="4) ปฏิบัติงานอื่นตามที่ได้รับมอบหมาย">
            4) ปฏิบัติงานอื่นตามที่ได้รับมอบหมาย
          </option>
        </select>

        <label>ลิงก์ผลงาน (ถ้ามี)</label>
        <input type="url" id="url" placeholder="ไม่บังคับ" />

        <label>เลือกรูปภาพ 1–6 รูป</label>
        <input type="file" id="images" accept="image/*" multiple />
        <div id="preview" class="preview-row"></div>

        <button type="button" id="submitBtn">บันทึกผลงาน</button>
        <button type="button" id="clearBtn">ล้างข้อมูล</button>
        <button type="button" id="navIndex">ดูรายการผลงาน</button>
        <button type="button" id="navReport">ออกบันทึกข้อความ</button>
      </form>
    </div>

    <script>
      // ====== API Script ของพี่ ======
      const API_URL =
        "https://script.google.com/macros/s/AKfycbwFrlrTolBpXQNJ3w6ExZwDKLz_540dEhs3wKTiWCb7u2UzywZsAG349rlXGKSZ3QM74A/exec";

      // ====== โหลด config ======
      (function initConfig() {
        const cfgText = localStorage.getItem("SMARTWORK_CONFIG");
        if (!cfgText) {
          Swal.fire(
            "ยังไม่ได้ตั้งค่าระบบ",
            "โปรดตั้งค่าที่หน้า config.html",
            "warning"
          ).then(() => (location.href = "config.html"));
          return;
        }

        const cfg = JSON.parse(cfgText);

        // หากไม่ครบ → รีเซทใหม่
        if (!cfg.fullname || !cfg.position || !cfg.district) {
          Swal.fire(
            "ข้อมูลไม่ครบ",
            "โปรดตั้งค่าใหม่ในหน้า config.html",
            "warning"
          ).then(() => (location.href = "config.html"));
          return;
        }

        fullname.value = cfg.fullname;
        position.value = cfg.position;
        unit.value =
          "สกร.อ." + cfg.district + " สำนักงาน สกร.ประจำจังหวัดศรีสะเกษ";
      })();

      // ====== Preview รูป ======
      images.addEventListener("change", function () {
        const box = preview;
        box.innerHTML = "";
        [...this.files].forEach((file) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = document.createElement("img");
            img.src = e.target.result;
            box.appendChild(img);
          };
          reader.readAsDataURL(file);
        });
      });

      // ====== Resize Image ก่อนส่งขึ้น GAS ======
      function resizeImage(file) {
        return new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = (e) => {
            const img = new Image();
            img.onload = () => {
              const MAX = 1280;
              let w = img.width;
              let h = img.height;

              if (w > h && w > MAX) {
                h = h * (MAX / w);
                w = MAX;
              } else if (h > MAX) {
                w = w * (MAX / h);
                h = MAX;
              }

              const canvas = document.createElement("canvas");
              canvas.width = w;
              canvas.height = h;
              canvas.getContext("2d").drawImage(img, 0, 0, w, h);

              resolve(canvas.toDataURL("image/jpeg", 0.8));
            };
            img.src = e.target.result;
          };
          reader.readAsDataURL(file);
        });
      }

      // ====== Submit งาน ======
      submitBtn.onclick = async () => {
        const cfg = JSON.parse(
          localStorage.getItem("SMARTWORK_CONFIG") || "{}"
        );

        // ตรวจข้อมูลจำเป็น
        if (
          !workDate.value ||
          !title.value.trim() ||
          !detail.value.trim() ||
          !indicator.value
        ) {
          Swal.fire("กรุณากรอกข้อมูลให้ครบ", "", "warning");
          return;
        }

        Swal.fire({
          title: "กำลังบันทึก...",
          allowOutsideClick: false,
          didOpen: () => Swal.showLoading(),
        });

        // Resize 1–6 รูป
        const files = [...images.files].slice(0, 6);
        const resized = [];
        for (const f of files) resized.push(await resizeImage(f));

        const payload = {
          name: cfg.fullname,
          pos: cfg.position,
          unit: "สกร.อ." + cfg.district,
          workDate: workDate.value,
          title: title.value.trim(),
          detail: detail.value.trim(),
          indicator: indicator.value,
          url: url.value.trim(),
          pics: resized,
        };

        try {
          const res = await fetch(API_URL, {
            method: "POST",
            body: JSON.stringify(payload),
          });

          const json = await res.json();

          if (json.status === "OK") {
            Swal.fire("บันทึกสำเร็จ", "", "success").then(() => {
              workDate.value = "";
              title.value = "";
              detail.value = "";
              indicator.value = "";
              url.value = "";
              images.value = "";
              preview.innerHTML = "";
            });
          } else {
            Swal.fire("ผิดพลาด", json.message || "บันทึกไม่สำเร็จ", "error");
          }
        } catch (err) {
          Swal.fire("ผิดพลาด", err.message, "error");
        }
      };

      // ====== Navigation ======
      navIndex.onclick = () => (location.href = "index.html");
      navReport.onclick = () => (location.href = "report.html");

      // ====== Clear ======
      clearBtn.onclick = () => {
        workDate.value = "";
        title.value = "";
        detail.value = "";
        indicator.value = "";
        url.value = "";
        images.value = "";
        preview.innerHTML = "";
      };
    </script>
  </body>
</html>
